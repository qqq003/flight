name: Amadeus Smoke Test

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      AMADEUS_CLIENT_ID: ${{ secrets.AMADEUS_CLIENT_ID }}
      AMADEUS_CLIENT_SECRET: ${{ secrets.AMADEUS_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # 用于可选测试
          pip install pytest
          # token smoke 需要 requests（通常项目已有；没有就补上）
          python - <<'PY'
import importlib.util, sys
if importlib.util.find_spec("requests") is None:
    sys.exit(1)
PY
          if [ $? -ne 0 ]; then pip install requests; fi

      - name: Verify env loaded (no secrets printed)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${AMADEUS_CLIENT_ID:-}" ]; then
            echo "AMADEUS_CLIENT_ID is EMPTY"
            exit 1
          else
            echo "AMADEUS_CLIENT_ID is SET"
          fi

          if [ -z "${AMADEUS_CLIENT_SECRET:-}" ]; then
            echo "AMADEUS_CLIENT_SECRET is EMPTY"
            exit 1
          else
            echo "AMADEUS_CLIENT_SECRET is SET"
          fi

      - name: Run tests (ignore 'no tests collected')
        shell: bash
        run: |
          set -euo pipefail
          set +e
          pytest -q
          code=$?
          set -e
          if [ "$code" -ne 0 ] && [ "$code" -ne 5 ]; then
            echo "pytest failed with exit code $code"
            exit "$code"
          fi
          echo "pytest exit code: $code (0=ok,5=no tests collected)"

      - name: Amadeus token smoke (live connectivity; no token printed)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
import os, requests
cid=os.getenv("AMADEUS_CLIENT_ID")
sec=os.getenv("AMADEUS_CLIENT_SECRET")
assert cid and sec, "missing amadeus creds"

url="https://test.api.amadeus.com/v1/security/oauth2/token"
r=requests.post(
  url,
  data={"grant_type":"client_credentials","client_id":cid,"client_secret":sec},
  timeout=20
)

print("token_url", url)
print("token_status", r.status_code)
print("content_type", r.headers.get("content-type",""))
# 不打印 token，只打印响应体前 120 字符用于定位（通常是 JSON 错误信息）
print("body_prefix", (r.text or "")[:120].replace("\n"," "))
PY

      - name: Run planner (debug + run)
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "Top-level files:"
          ls -la

          echo "Find planner.py (maxdepth 3):"
          find . -maxdepth 3 -name "planner.py" -print

          if [ -f "./planner.py" ]; then
            echo "Running: python ./planner.py"
            python ./planner.py
            exit 0
          fi

          p="$(find . -maxdepth 3 -name "planner.py" -print | head -n 1)"
          if [ -z "$p" ]; then
            echo "planner.py not found in this checkout."
            echo "If your entrypoint is different, edit this workflow to run the correct command from README."
            exit 1
          fi

          echo "Running: python $p"
          python "$p"
