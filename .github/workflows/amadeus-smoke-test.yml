name: Amadeus Live Update + Planner

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      AMADEUS_CLIENT_ID: ${{ secrets.AMADEUS_CLIENT_ID }}
      AMADEUS_CLIENT_SECRET: ${{ secrets.AMADEUS_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          # 你的项目没 requirements.txt 也没关系
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests

      - name: Verify env loaded (no secrets printed)
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${AMADEUS_CLIENT_ID:-}" ] && echo "AMADEUS_CLIENT_ID is SET" || (echo "AMADEUS_CLIENT_ID is EMPTY" && exit 1)
          [ -n "${AMADEUS_CLIENT_SECRET:-}" ] && echo "AMADEUS_CLIENT_SECRET is SET" || (echo "AMADEUS_CLIENT_SECRET is EMPTY" && exit 1)

      - name: Snapshot data BEFORE update
        shell: bash
        run: |
          set -euo pipefail
          echo "=== routes_config.json ==="
          cat data/routes_config.json
          echo "=== sample_options.json (before) ==="
          cat data/sample_options.json

      - name: Fetch live prices from Amadeus and update JSON
        shell: bash
        run: |
          set -euo pipefail
          python scripts/update_prices.py --config data/routes_config.json --data data/sample_options.json

      - name: Show changes AFTER update (prove live update happened)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== sample_options.json (after) ==="
          cat data/sample_options.json
          echo "=== git diff (data/sample_options.json) ==="
          git diff -- data/sample_options.json || true

      - name: Run planner using updated data
        shell: bash
        run: |
          set -euo pipefail
          python planner.py --data data/sample_options.json

      - name: Summarize & rank routes (total cost)
        run: |
          python scripts/summarize_and_rank.py

      - name: Summarize results to a table
        run: |
          python scripts/summarize_results.py

      - name: Upload summary as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary
          path: summary.md

      - name: Upload updated data as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: updated-data
          path: |
            data/sample_options.json
            data/routes_config.json
      - name: Upload outputs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: |
            summary.md
            data/sample_options.json
            data/routes_config.json
