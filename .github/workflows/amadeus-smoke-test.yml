name: Amadeus Smoke Test

on:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      AMADEUS_CLIENT_ID: ${{ secrets.AMADEUS_CLIENT_ID }}
      AMADEUS_CLIENT_SECRET: ${{ secrets.AMADEUS_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest requests

      - name: Verify env loaded (no secrets printed)
        run: |
          if [ -z "${AMADEUS_CLIENT_ID:-}" ]; then
            echo "AMADEUS_CLIENT_ID is EMPTY"
            exit 1
          else
            echo "AMADEUS_CLIENT_ID is SET"
          fi

          if [ -z "${AMADEUS_CLIENT_SECRET:-}" ]; then
            echo "AMADEUS_CLIENT_SECRET is EMPTY"
            exit 1
          else
            echo "AMADEUS_CLIENT_SECRET is SET"
          fi

      - name: Run tests (ignore 'no tests collected')
        run: |
          set +e
          pytest -q
          code=$?
          set -e
          if [ "$code" -ne 0 ] && [ "$code" -ne 5 ]; then
            echo "pytest failed with exit code $code"
            exit "$code"
          fi
          echo "pytest exit code: $code (0=ok,5=no tests collected)"

      - name: Amadeus token smoke (live connectivity; no token printed)
        run: |
          python - <<'PY'
          import os, requests
          cid = os.getenv("AMADEUS_CLIENT_ID")
          sec = os.getenv("AMADEUS_CLIENT_SECRET")
          assert cid and sec, "missing amadeus creds"

          url = "https://test.api.amadeus.com/v1/security/oauth2/token"
          r = requests.post(
              url,
              data={
                  "grant_type": "client_credentials",
                  "client_id": cid,
                  "client_secret": sec,
              },
              timeout=20,
          )

          print("token_url", url)
          print("token_status", r.status_code)
          print("content_type", r.headers.get("content-type", ""))
          print("body_prefix", (r.text or "")[:120].replace("\n", " "))
          PY

      - name: Inspect planner.py for live/mock switch
        run: |
          python - <<'PY'
          import re, pathlib
          p = pathlib.Path("planner.py")
          t = p.read_text(encoding="utf-8", errors="ignore")
          # 打印包含关键字的行（不泄露密钥）
          keys = ["AMADEUS", "amadeus", "sample_options", "routes_config", "test.api.amadeus.com", "oauth2", "flight-offers", "requests"]
          for i, line in enumerate(t.splitlines(), 1):
              if any(k in line for k in keys):
                  print(f"{i:04d}: {line}")
          PY


      - name: Run planner (debug + run)
        run: |
          echo "PWD=$(pwd)"
          echo "Top-level files:"
          ls -la

          echo "Find planner.py (maxdepth 3):"
          find . -maxdepth 3 -name "planner.py" -print

          if [ -f "./planner.py" ]; then
            echo "Running: python ./planner.py"
            python ./planner.py
            exit 0
          fi

          p="$(find . -maxdepth 3 -name "planner.py" -print | head -n 1)"
          if [ -z "$p" ]; then
            echo "planner.py not found in this checkout."
            exit 1
          fi

          echo "Running: python $p"
          python "$p"
